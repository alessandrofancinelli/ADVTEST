import React, { useState, useMemo, useCallback, useEffect } from 'react';
import { ChevronRight, ChevronLeft, UploadCloud, CheckCircle, XCircle, Calendar as CalendarIcon, Target, FileImage, Tv, Building2, Handshake, Image as ImageIcon, Sparkles, MapPin, LayoutDashboard, PlusCircle, UserCircle, BarChart2, DollarSign, Eye, PauseCircle, Users, Percent } from 'lucide-react';

// --- DATI DI SIMULAZIONE GLOBALI ---

const MOCK_CAMPAIGNS = [
  { id: 1, nomeCampagna: 'Lancio Estivo Gelati', status: 'Completata', startDate: '2025-06-01', endDate: '2025-06-15', spesa: 2500, impressions: 120000, soste: 3100, etaMedia: 34, sesso: { M: 45, F: 55 } },
  { id: 2, nomeCampagna: 'Offerta Speciale Pasta', status: 'Attiva', startDate: '2025-06-20', endDate: '2025-07-05', spesa: 1800, impressions: 95000, soste: 1850, etaMedia: 42, sesso: { M: 30, F: 70 } },
  { id: 3, nomeCampagna: 'Promozione Vini Locali', status: 'Completata', startDate: '2025-05-10', endDate: '2025-05-25', spesa: 3200, impressions: 150000, soste: 4200, etaMedia: 48, sesso: { M: 65, F: 35 } },
  { id: 4, nomeCampagna: 'Back to School 2025', status: 'In Approvazione', startDate: '2025-08-15', endDate: '2025-09-01', spesa: 4000, impressions: 0, soste: 0, etaMedia: 0, sesso: { M: 0, F: 0 } },
];

const TIPI_STORE = ["Super Store", "City", "Spazio", "Conad"];
const COOPERATIVE = ["PAC", "DAO", "CCN", "CNO", "CIA"];

const COOPERATIVE_REGIONS = {
  "PAC": ["Lombardia", "Piemonte", "Veneto", "Liguria", "Emilia-Romagna", "Trentino-Alto Adige", "Friuli Venezia Giulia", "Valle d'Aosta"],
  "DAO": ["Trentino-Alto Adige", "Veneto", "Lombardia"],
  "CCN": ["Toscana", "Umbria", "Lazio", "Marche", "Sardegna"],
  "CNO": ["Campania", "Puglia", "Basilicata", "Calabria", "Sicilia"],
  "CIA": ["Lazio", "Abruzzo", "Molise", "Emilia-Romagna", "Marche"]
};

const FORMATI_PAC = [
  { w: 312, h: 156 }, { w: 320, h: 400 }, { w: 320, h: 800 }, { w: 336, h: 336 }, { w: 384, h: 256 }, { w: 480, h: 800 }, { w: 576, h: 432 }, { w: 588, h: 504 }, { w: 640, h: 576 }, { w: 641, h: 384 }, { w: 768, h: 128 }, { w: 768, h: 288 }, { w: 768, h: 512 }, { w: 768, h: 996 }, { w: 768, h: 1024 }, { w: 800, h: 240 }, { w: 800, h: 462 }, { w: 800, h: 600 }, { w: 842, h: 258 }, { w: 960, h: 480 }, { w: 1024, h: 256 }, { w: 1024, h: 600 }, { w: 1024, h: 1024 }, { w: 1080, h: 1080 }, { w: 1080, h: 1200 }, { w: 1080, h: 1920 }, { w: 1152, h: 576 }, { w: 1366, h: 578 }, { w: 1376, h: 258 }, { w: 1512, h: 420 }, { w: 1512, h: 432 }, { w: 1536, h: 480 }, { w: 1548, h: 258 }, { w: 1704, h: 720 }, { w: 1760, h: 240 }, { w: 1920, h: 192 }, { w: 1920, h: 1080 }, { w: 2064, h: 258 }, { w: 2160, h: 1280 }, { w: 2560, h: 384 }, { w: 2560, h: 720 }, { w: 2592, h: 540 }, { w: 3408, h: 720 }, { w: 3840, h: 540 }, { w: 3840, h: 720 }, { w: 3840, h: 1080 }, { w: 4320, h: 1920 }
].map(f => ({...f, name: `PAC ${f.w}x${f.h}`}));

const FORMATI_SCHERMO_DEFAULT = {
  "Lombardia": [{ w: 1920, h: 1080, name: "Display Cassa" }, { w: 1080, h: 1920, name: "Totem Ingresso" }],
  "Lazio": [{ w: 1920, h: 1080, name: "Display Cassa" }, { w: 720, h: 1280, name: "Schermo Reparto" }],
  "Sicilia": [{ w: 1280, h: 720, name: "Display Bilancia" }],
  "default": [{ w: 1920, h: 1080, name: "Standard HD" }, { w: 1080, h: 1920, name: "Standard Verticale" }]
};

const MASTER_FORMAT_KEY = '1920x1080';
const SLOT_PRENOTATI = [
    { from: new Date('2025-08-10'), to: new Date('2025-08-18') },
    { from: new Date('2025-09-01'), to: new Date('2025-09-05') }
];

// --- COMPONENTI UI ---
const Card = ({ children, className = '' }) => <div className={`bg-white border border-gray-200 rounded-lg shadow-sm ${className}`}>{children}</div>;
const Button = ({ children, onClick, variant = 'primary', disabled = false, className = '' }) => {
  const baseClasses = 'px-6 py-2.5 rounded-md font-semibold text-sm transition-all focus:outline-none focus:ring-2 focus:ring-offset-2';
  const variantClasses = { primary: 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500', secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300 focus:ring-gray-400', ghost: 'bg-transparent text-blue-600 hover:bg-blue-50' };
  const disabledClasses = 'disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed';
  return <button onClick={onClick} disabled={disabled} className={`${baseClasses} ${variantClasses[variant]} ${disabledClasses} ${className}`}>{children}</button>;
};

// --- COMPONENTI SPECIFICI ---

const StatusBadge = ({ status }) => {
    const styles = {
        'Attiva': 'bg-green-100 text-green-800',
        'Completata': 'bg-gray-100 text-gray-800',
        'In Approvazione': 'bg-yellow-100 text-yellow-800',
    };
    return <span className={`px-2.5 py-0.5 text-xs font-medium rounded-full ${styles[status] || 'bg-red-100 text-red-800'}`}>{status}</span>;
};

const ReportsDashboard = ({ campaigns, createCampaign }) => {
    const summary = useMemo(() => {
        return campaigns.reduce((acc, c) => {
            acc.totalSpesa += c.spesa;
            acc.totalImpressions += c.impressions;
            acc.totalSoste += c.soste;
            if (c.status === 'Attiva') acc.activeCampaigns += 1;
            return acc;
        }, { totalSpesa: 0, totalImpressions: 0, totalSoste: 0, activeCampaigns: 0 });
    }, [campaigns]);

    const formatNumber = (num) => num.toLocaleString('it-IT');
    const formatCurrency = (num) => num.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });

    return (
        <div className="space-y-8">
            <div>
                <h1 className="text-3xl font-bold text-gray-900">Dashboard dei Report</h1>
                <p className="text-gray-500 mt-1">Panoramica delle tue campagne pubblicitarie.</p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <Card className="p-6"><div className="flex items-center"><div className="p-3 rounded-full bg-blue-100 text-blue-600 mr-4"><DollarSign size={24}/></div><div><p className="text-sm text-gray-500">Spesa Totale</p><p className="text-2xl font-bold text-gray-800">{formatCurrency(summary.totalSpesa)}</p></div></div></Card>
                <Card className="p-6"><div className="flex items-center"><div className="p-3 rounded-full bg-green-100 text-green-600 mr-4"><Eye size={24}/></div><div><p className="text-sm text-gray-500">Impressions Totali</p><p className="text-2xl font-bold text-gray-800">{formatNumber(summary.totalImpressions)}</p></div></div></Card>
                <Card className="p-6"><div className="flex items-center"><div className="p-3 rounded-full bg-yellow-100 text-yellow-600 mr-4"><PauseCircle size={24}/></div><div><p className="text-sm text-gray-500">Soste Totali</p><p className="text-2xl font-bold text-gray-800">{formatNumber(summary.totalSoste)}</p></div></div></Card>
                <Card className="p-6"><div className="flex items-center"><div className="p-3 rounded-full bg-indigo-100 text-indigo-600 mr-4"><BarChart2 size={24}/></div><div><p className="text-sm text-gray-500">Campagne Attive</p><p className="text-2xl font-bold text-gray-800">{summary.activeCampaigns}</p></div></div></Card>
            </div>

            <Card className="overflow-x-auto">
                <div className="p-6 flex justify-between items-center">
                    <h2 className="text-xl font-bold text-gray-800">Storico Campagne</h2>
                    <Button onClick={createCampaign}><PlusCircle size={16} className="inline mr-2"/> Nuova Campagna</Button>
                </div>
                <table className="w-full text-sm text-left text-gray-500">
                    <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" className="px-6 py-3">Nome Campagna</th>
                            <th scope="col" className="px-6 py-3">Stato</th>
                            <th scope="col" className="px-6 py-3">Periodo</th>
                            <th scope="col" className="px-6 py-3 text-right">Spesa</th>
                            <th scope="col" className="px-6 py-3 text-right">Impressions</th>
                            <th scope="col" className="px-6 py-3 text-right">Soste</th>
                            <th scope="col" className="px-6 py-3 text-right">Tasso Sosta</th>
                            <th scope="col" className="px-6 py-3 text-center">Et√† Media</th>
                            <th scope="col" className="px-6 py-3">Sesso (% Soste)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {campaigns.map(c => (
                            <tr key={c.id} className="bg-white border-b hover:bg-gray-50">
                                <th scope="row" className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">{c.nomeCampagna}</th>
                                <td className="px-6 py-4"><StatusBadge status={c.status} /></td>
                                <td className="px-6 py-4">{new Date(c.startDate).toLocaleDateString('it-IT')} - {new Date(c.endDate).toLocaleDateString('it-IT')}</td>
                                <td className="px-6 py-4 text-right">{formatCurrency(c.spesa)}</td>
                                <td className="px-6 py-4 text-right">{formatNumber(c.impressions)}</td>
                                <td className="px-6 py-4 text-right">{formatNumber(c.soste)}</td>
                                <td className="px-6 py-4 text-right">{c.impressions > 0 ? ((c.soste / c.impressions) * 100).toFixed(2) : '0.00'}%</td>
                                <td className="px-6 py-4 text-center">{c.etaMedia > 0 ? c.etaMedia : 'N/A'}</td>
                                <td className="px-6 py-4">{c.sesso.M > 0 || c.sesso.F > 0 ? `M: ${c.sesso.M}% / F: ${c.sesso.F}%` : 'N/A'}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </Card>
        </div>
    );
};

const CampaignCreator = ({ onCampaignLaunched }) => {
    const [step, setStep] = useState(1);
    const getInitialCampaign = () => ({ nomeCampagna: '', tipiStore: [], cooperative: [], regioni: [], creatives: {}, useMasterCreative: false, startDate: null, endDate: null });
    const [campaign, setCampaign] = useState(getInitialCampaign());

    const updateCampaign = useCallback((newData) => setCampaign(prev => ({ ...prev, ...newData })), []);
    const nextStep = () => setStep(s => s + 1);
    const prevStep = () => setStep(s => s - 1);
    const resetAndLaunch = () => {
        const newCampaignData = {
            id: Date.now(),
            ...campaign,
            status: 'In Approvazione',
            spesa: Math.floor(Math.random() * 3000) + 1000,
            impressions: 0,
            soste: 0,
            etaMedia: 0,
            sesso: { M: 0, F: 0 }
        };
        onCampaignLaunched(newCampaignData);
    };

    const renderStep = () => {
        switch (step) {
            case 1: return <Step1_TargetingAndScheduling campaign={campaign} updateCampaign={updateCampaign} onNext={nextStep} />;
            case 2: return <Step2_Creative campaign={campaign} updateCampaign={updateCampaign} onNext={nextStep} onBack={prevStep} />;
            case 3: return <Step3_Review campaign={campaign} onBack={prevStep} onLaunch={() => setStep(4)} />;
            case 4: return <Step4_Confirmation onLaunch={resetAndLaunch} />;
            default: return <div>Step non trovato</div>;
        }
    };

    return (
        <div>
            <header className="mb-8 text-center">
                <h1 className="text-3xl font-bold text-gray-900">Crea Nuova Campagna</h1>
                <p className="text-gray-500 mt-1">Segui i passaggi per configurare e lanciare la tua campagna.</p>
            </header>
            {step <= 3 && <StepIndicator currentStep={step} totalSteps={3} />}
            <main>{renderStep()}</main>
        </div>
    );
};

const StepIndicator = ({ currentStep, totalSteps }) => (
  <div className="flex items-center justify-center space-x-4 my-8">
    {Array.from({ length: totalSteps }).map((_, i) => {
      const step = i + 1;
      const isCompleted = step < currentStep;
      const isActive = step === currentStep;
      return (
        <React.Fragment key={step}>
          <div className="flex flex-col items-center">
            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${isCompleted ? 'bg-blue-600 text-white' : isActive ? 'bg-blue-100 text-blue-700 border-2 border-blue-600' : 'bg-gray-200 text-gray-500'}`}>
              {isCompleted ? <CheckCircle size={16} /> : step}
            </div>
          </div>
          {step < totalSteps && <div className={`flex-1 h-1 rounded ${isCompleted ? 'bg-blue-600' : 'bg-gray-200'}`}></div>}
        </React.Fragment>
      );
    })}
  </div>
);

const Step1_TargetingAndScheduling = ({ campaign, updateCampaign, onNext }) => {
  const { startDate, endDate } = campaign;
  
  const handleToggle = (field, value) => {
    const currentValues = campaign[field] || [];
    const newValues = currentValues.includes(value) ? currentValues.filter(v => v !== value) : [...currentValues, value];
    updateCampaign({ [field]: newValues });
  };
  
  const availableRegions = useMemo(() => {
    if (campaign.cooperative.length === 0) return [];
    const regions = new Set();
    campaign.cooperative.forEach(coop => (COOPERATIVE_REGIONS[coop] || []).forEach(region => regions.add(region)));
    return Array.from(regions).sort();
  }, [campaign.cooperative]);

  useEffect(() => {
    const validSelectedRegions = campaign.regioni.filter(r => availableRegions.includes(r));
    if (validSelectedRegions.length !== campaign.regioni.length) updateCampaign({ regioni: validSelectedRegions });
  }, [availableRegions, campaign.regioni, updateCampaign]);

  const handleSelectAllRegions = () => {
      const allSelected = availableRegions.length > 0 && availableRegions.length === campaign.regioni.length;
      updateCampaign({ regioni: allSelected ? [] : availableRegions });
  };

  const handleDateChange = (field, value) => {
    updateCampaign({ [field]: value });
  };

  const isDateAvailable = useMemo(() => {
      if (!startDate || !endDate) return null;
      const start = new Date(startDate);
      const end = new Date(endDate);
      if (start >= end) return false;
      for (const slot of SLOT_PRENOTATI) {
          const slotStart = new Date(slot.from);
          const slotEnd = new Date(slot.to);
          if (start < slotEnd && end > slotStart) return false;
      }
      return true;
  }, [startDate, endDate]);

  const today = new Date().toISOString().split('T')[0];
  const isNextDisabled = !campaign.nomeCampagna || !isDateAvailable || campaign.regioni.length === 0 || campaign.tipiStore.length === 0 || campaign.cooperative.length === 0;

  return (
    <Card className="p-6 md:p-8">
      <div className="flex items-center mb-6"><Target className="w-8 h-8 text-blue-600 mr-4" /><div><h2 className="text-xl font-bold text-gray-800">Target e Programmazione</h2><p className="text-gray-500">Definisci i parametri principali della campagna.</p></div></div>
      <div className="space-y-8">
        <div><label htmlFor="campaignName" className="block text-sm font-medium text-gray-700 mb-2">1. Nome della Campagna</label><input type="text" id="campaignName" value={campaign.nomeCampagna} onChange={(e) => updateCampaign({ nomeCampagna: e.target.value })} placeholder="Es. Lancio Prodotto Estivo" className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"/></div>
        
        <div>
            <h3 className="font-semibold text-gray-700 mb-3 flex items-center"><CalendarIcon size={18} className="mr-2"/>2. Periodo e Disponibilit√†</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-start p-4 border rounded-lg bg-gray-50">
                <div className="space-y-4">
                    <div><label htmlFor="startDate" className="block text-sm font-medium text-gray-700 mb-1">Data di inizio</label><input type="date" id="startDate" value={startDate || ''} min={today} onChange={(e) => handleDateChange('startDate', e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"/></div>
                    <div><label htmlFor="endDate" className="block text-sm font-medium text-gray-700 mb-1">Data di fine</label><input type="date" id="endDate" value={endDate || ''} min={startDate || today} onChange={(e) => handleDateChange('endDate', e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" disabled={!startDate}/></div>
                </div>
                <div className="p-4 rounded-lg bg-white h-full border border-gray-200">{isDateAvailable === null && <p className="text-gray-500 text-sm">Seleziona le date per verificare.</p>}{isDateAvailable === true && <div className="flex items-center text-green-600"><CheckCircle size={20} className="mr-2" /><p className="font-semibold">Slot disponibili!</p></div>}{isDateAvailable === false && <div className="flex items-center text-red-600"><XCircle size={20} className="mr-2" /><p className="font-semibold">Date non disponibili.</p></div>}</div>
            </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div><h3 className="font-semibold text-gray-700 mb-3 flex items-center"><Handshake size={18} className="mr-2"/>3. Cooperativa</h3><div className="space-y-2 max-h-48 overflow-y-auto pr-2">{COOPERATIVE.map(coop => <label key={coop} className="flex items-center p-3 bg-gray-50 rounded-md hover:bg-gray-100 cursor-pointer"><input type="checkbox" checked={campaign.cooperative.includes(coop)} onChange={() => handleToggle('cooperative', coop)} className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"/><span className="ml-3 text-sm text-gray-600">{coop}</span></label>)}</div></div>
            <div><h3 className="font-semibold text-gray-700 mb-3 flex items-center"><Building2 size={18} className="mr-2"/>4. Tipologia Store</h3><div className="space-y-2 max-h-48 overflow-y-auto pr-2">{TIPI_STORE.map(type => <label key={type} className="flex items-center p-3 bg-gray-50 rounded-md hover:bg-gray-100 cursor-pointer"><input type="checkbox" checked={campaign.tipiStore.includes(type)} onChange={() => handleToggle('tipiStore', type)} className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"/><span className="ml-3 text-sm text-gray-600">{type}</span></label>)}</div></div>
        </div>
        <div>
          <div className="flex justify-between items-center mb-3"><h3 className="font-semibold text-gray-700 flex items-center"><MapPin size={18} className="mr-2"/>5. Zone Geografiche</h3>{campaign.cooperative.length > 0 && <Button onClick={handleSelectAllRegions} variant="ghost" className="py-1 px-2 text-xs">{availableRegions.length === campaign.regioni.length ? 'Deseleziona tutto' : 'Seleziona tutto'}</Button>}</div>
          {campaign.cooperative.length > 0 ? <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">{availableRegions.map(region => <label key={region} className="flex items-center p-2 bg-gray-50 rounded-md hover:bg-gray-100 cursor-pointer text-xs"><input type="checkbox" checked={campaign.regioni.includes(region)} onChange={() => handleToggle('regioni', region)} className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"/><span className="ml-2 text-gray-600">{region}</span></label>)}</div> : <div className="text-center py-4 px-3 bg-gray-100 rounded-md"><p className="text-sm text-gray-600">Seleziona una cooperativa per vedere le zone.</p></div>}
        </div>
      </div>
      <div className="mt-8 pt-6 border-t border-gray-200 flex justify-end"><Button onClick={onNext} disabled={isNextDisabled}>Avanti: Creativit√† <ChevronRight size={16} className="inline ml-2" /></Button></div>
    </Card>
  );
};

const Step2_Creative = ({ campaign, updateCampaign, onNext, onBack }) => {
  const { creatives, useMasterCreative } = campaign;

  const formatiRichiesti = useMemo(() => {
    let formati;
    if (campaign.cooperative.includes('PAC')) formati = [...FORMATI_PAC];
    else {
      const formatiSet = new Set();
      campaign.regioni.forEach(regione => (FORMATI_SCHERMO_DEFAULT[regione] || FORMATI_SCHERMO_DEFAULT.default).forEach(f => formatiSet.add(JSON.stringify(f))));
      formati = Array.from(formatiSet).map(f => JSON.parse(f));
    }
    const masterIndex = formati.findIndex(f => `${f.w}x${f.h}` === MASTER_FORMAT_KEY);
    if (masterIndex > -1) {
        const masterFormat = formati.splice(masterIndex, 1)[0];
        formati.unshift(masterFormat);
    }
    return formati;
  }, [campaign.cooperative, campaign.regioni]);

  const handleFileChange = (e, formatKey) => {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => updateCampaign({ creatives: { ...creatives, [formatKey]: { name: file.name, url: event.target.result, w: img.width, h: img.height }}});
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  };

  const isNextDisabled = useMasterCreative ? !creatives[MASTER_FORMAT_KEY] : Object.keys(creatives).length < formatiRichiesti.length;

  return (
    <Card className="p-6 md:p-8">
      <div className="flex items-center mb-6"><FileImage className="w-8 h-8 text-blue-600 mr-4" /><div><h2 className="text-xl font-bold text-gray-800">Creativit√† dell'annuncio</h2><p className="text-gray-500">Carica i contenuti per i formati richiesti o usa una creativit√† master.</p></div></div>
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div className="space-y-4"><h3 className="font-semibold text-gray-700 mb-2">Carica creativit√† per formato</h3><div className="space-y-3 max-h-[60vh] overflow-y-auto p-2 border rounded-lg bg-gray-50">{formatiRichiesti.map(formato => { const formatKey = `${formato.w}x${formato.h}`, creative = creatives[formatKey], isMasterFormat = formatKey === MASTER_FORMAT_KEY; return (<div key={formatKey} className="bg-white p-3 rounded-md shadow-sm border"><div className="flex items-center justify-between"><div className="flex items-center">{creative ? <CheckCircle size={16} className="text-green-500 mr-2"/> : <ImageIcon size={16} className="text-gray-400 mr-2"/>}<span className="font-mono text-sm font-medium text-gray-800">{formatKey}</span><span className="text-xs text-gray-500 ml-2 hidden sm:inline">({formato.name})</span></div><label htmlFor={`file-${formatKey}`} className="text-sm text-blue-600 hover:text-blue-800 font-semibold cursor-pointer">{creative ? 'Sostituisci' : 'Carica'}<input id={`file-${formatKey}`} type="file" className="sr-only" onChange={(e) => handleFileChange(e, formatKey)} accept="image/*"/></label></div>{creative && <p className="text-xs text-gray-500 mt-1 truncate">File: {creative.name}</p>}{isMasterFormat && <div className="mt-3 pt-3 border-t border-gray-200"><label className="flex items-center text-sm text-gray-700"><input type="checkbox" checked={useMasterCreative} onChange={(e) => updateCampaign({ useMasterCreative: e.target.checked })} className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"/><span className="ml-2">Usa come creativit√† <strong className="text-blue-600">master</strong></span><Sparkles size={16} className="ml-1 text-yellow-500"/></label><p className="text-xs text-gray-500 ml-6">Adatta questa creativit√† per i formati senza un file specifico.</p></div>}</div>)})}</div></div>
        <div className="space-y-4"><h3 className="font-semibold text-gray-700 mb-2">Anteprime</h3><div className="space-y-4 max-h-[60vh] overflow-y-auto p-2 border rounded-lg bg-gray-50">{formatiRichiesti.map(formato => { const formatKey = `${formato.w}x${formato.h}`, specificCreative = creatives[formatKey], masterCreative = useMasterCreative ? creatives[MASTER_FORMAT_KEY] : null, finalCreative = specificCreative || masterCreative; return (<div key={`preview-${formatKey}`} className="bg-white p-3 rounded-lg shadow-sm border"><p className="text-sm font-medium text-gray-800 flex justify-between items-center"><span>{formato.name} <span className="font-normal text-gray-500">({formatKey}px)</span></span>{!specificCreative && masterCreative && <span className="text-xs bg-blue-100 text-blue-700 font-bold py-0.5 px-1.5 rounded">MASTER</span>}</p><div className="mt-2 w-full bg-gray-900 rounded flex items-center justify-center overflow-hidden" style={{ aspectRatio: `${formato.w}/${formato.h}` }}>{finalCreative ? <div style={{width: '100%', height: '100%', backgroundImage: `url(${finalCreative.url})`, backgroundSize: 'contain', backgroundRepeat: 'no-repeat', backgroundPosition: 'center'}} /> : <div className="text-gray-500 text-xs p-2 text-center">Nessuna creativit√†</div>}</div></div>)})}</div></div>
      </div>
      <div className="mt-8 pt-6 border-t border-gray-200 flex justify-between"><Button onClick={onBack} variant="secondary"><ChevronLeft size={16} className="inline mr-2" /> Indietro</Button><Button onClick={onNext} disabled={isNextDisabled}>Avanti: Riepilogo <ChevronRight size={16} className="inline ml-2" /></Button></div>
    </Card>
  );
};

const Step3_Review = ({ campaign, onBack, onLaunch }) => (
    <Card className="p-6 md:p-8"><div className="flex items-center mb-6"><CheckCircle className="w-8 h-8 text-blue-600 mr-4" /><div><h2 className="text-xl font-bold text-gray-800">Riepilogo e Lancio</h2><p className="text-gray-500">Controlla i dettagli prima di lanciare.</p></div></div><div className="space-y-6"><div className="p-4 bg-gray-50 rounded-lg"><h3 className="font-semibold text-gray-800">Nome Campagna</h3><p className="text-blue-700 text-lg">{campaign.nomeCampagna}</p></div><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div className="p-4 bg-gray-50 rounded-lg"><h3 className="font-semibold text-gray-800 mb-2">Target</h3><p className="text-sm text-gray-600"><strong>Cooperative:</strong> {campaign.cooperative.join(', ')}</p><p className="text-sm text-gray-600"><strong>Tipi Store:</strong> {campaign.tipiStore.join(', ')}</p><p className="text-sm text-gray-600"><strong>Regioni:</strong> {campaign.regioni.join(', ')}</p></div><div className="p-4 bg-gray-50 rounded-lg"><h3 className="font-semibold text-gray-800 mb-2">Programmazione</h3><p className="text-sm text-gray-600"><strong>Dal:</strong> {new Date(campaign.startDate).toLocaleDateString('it-IT')}</p><p className="text-sm text-gray-600"><strong>Al:</strong> {new Date(campaign.endDate).toLocaleDateString('it-IT')}</p></div></div><div className="p-4 bg-gray-50 rounded-lg"><h3 className="font-semibold text-gray-800 mb-2">Creativit√† Master (1920x1080)</h3>{campaign.creatives[MASTER_FORMAT_KEY] ? <img src={campaign.creatives[MASTER_FORMAT_KEY].url} alt="Creativit√† Master" className="max-w-xs mx-auto rounded-md shadow-md" /> : <p className="text-gray-500 text-center">Nessuna creativit√† master definita.</p>}</div></div><div className="mt-8 pt-6 border-t border-gray-200 flex justify-between"><Button onClick={onBack} variant="secondary"><ChevronLeft size={16} className="inline mr-2" /> Indietro</Button><Button onClick={onLaunch} variant="primary">Conferma e Lancia</Button></div></Card>
);

const Step4_Confirmation = ({ onLaunch }) => (
    <Card className="text-center p-10">
        <CheckCircle className="w-16 h-16 text-green-500 mx-auto mb-4" />
        <h2 className="text-2xl font-bold text-gray-800">Quasi Fatto!</h2>
        <p className="text-gray-600 mt-2 mb-6">La tua campagna sta per essere inviata per l'approvazione. Sar√† visibile nella dashboard dei report.</p>
        <Button onClick={onLaunch}>
            Lancia e Torna alla Dashboard
        </Button>
    </Card>
);


// --- COMPONENTE PRINCIPALE ---

export default function App() {
  const [view, setView] = useState('dashboard'); // 'dashboard' or 'creator'
  const [campaigns, setCampaigns] = useState(MOCK_CAMPAIGNS);

  const handleCampaignLaunched = (newCampaign) => {
      setCampaigns(prev => [...prev, newCampaign]);
      setView('dashboard');
  };

  return (
    <div className="bg-gray-100 min-h-screen font-sans flex">
        {/* Sidebar di Navigazione */}
        <aside className="w-64 bg-white border-r border-gray-200 p-6 flex-shrink-0 hidden md:flex md:flex-col">
            <h1 className="text-2xl font-bold text-blue-600 mb-10">ADV Manager</h1>
            <nav className="space-y-2">
                <a href="#" onClick={() => setView('dashboard')} className={`flex items-center px-4 py-2.5 rounded-lg text-sm font-medium ${view === 'dashboard' ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                    <LayoutDashboard size={18} className="mr-3"/> Dashboard
                </a>
                <a href="#" onClick={() => setView('creator')} className={`flex items-center px-4 py-2.5 rounded-lg text-sm font-medium ${view === 'creator' ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                    <PlusCircle size={18} className="mr-3"/> Crea Campagna
                </a>
            </nav>
        </aside>

        {/* Contenuto Principale */}
        <div className="flex-1 flex flex-col">
            <header className="bg-white border-b border-gray-200 px-4 md:px-8 py-4 flex justify-between items-center">
                 <h1 className="text-xl font-bold text-blue-600 md:hidden">ADV Manager</h1>
                <div className="flex items-center ml-auto">
                    <span className="text-sm text-gray-600 mr-3 hidden sm:inline">Benvenuto, <strong>Mario Rossi</strong></span>
                    <UserCircle size={32} className="text-gray-400"/>
                </div>
            </header>
            <main className="flex-1 p-4 md:p-8 overflow-y-auto">
                {view === 'dashboard' && <ReportsDashboard campaigns={campaigns} createCampaign={() => setView('creator')} />}
                {view === 'creator' && <CampaignCreator onCampaignLaunched={handleCampaignLaunched} />}
            </main>
        </div>
    </div>
  );
}
